<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
<script src="mnist_ui.js"></script>
<style>
  #mnist * { display: block; }
  #mnist canvas { border: 1px solid black; }
</style>

<pre id="status">initializing...</pre>
<div id="mnist"></div>

<script>

const status = document.querySelector('#status')
status.innerText = 'loading model: 0%'

window.onerror = (message, source, lineno, colno, error) =>
  status.innerText = `### JAVASCRIPT ERROR: ${message} at ${source}:${lineno}`;

const modelDir = 'tfjs_model';
tf.loadGraphModel(modelDir + '/model.json', {
    onProgress: p => status.innerText = `loading model: ${Math.round(p*100)}%`
}).then(model => {
  console.log('loaded', model)
  status.textContent = 'ready!'

  const ui = mnist_ui(document.querySelector('#mnist'))
  ui.onUpdate(img => {
    const imgs = tf.tensor(img).cast('float32').reshape([1, 28, 28, 1])
    const logits = model.predict(imgs)
    const preds = tf.softmax(logits)
    const { values, indices } = tf.topk(preds, 10)

    ui.showPreds([...values.dataSync()], [...indices.dataSync()])
  })

}).catch(error => {
  status.textContent = 'ERROR : ' + error.message
})
</script>