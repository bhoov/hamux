<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.1.0"></script>
<script src="mnist_ui.js"></script>
<style>
  #mnist * { display: block; }
  #mnist canvas { border: 1px solid black; }
</style>

<pre id="status">initializing...</pre>
<div id="mnist"></div>

<script>

const status = document.querySelector('#status')
status.innerText = 'loading model: 0%'

window.onerror = (message, source, lineno, colno, error) =>
  status.innerText = `### JAVASCRIPT ERROR: ${message} at ${source}:${lineno}`;

// Bypass finite-ness checking
// Bypass finite-ness checking
const IsFinite = (node) => {
  if (node.inputs) {
    return tf.logicalNot(tf.logicalOr(tf.isNaN(node.inputs[0]), tf.isInf(node.inputs[0])))
  }
  return true
  // return true
}
tf.registerOp('IsFinite', IsFinite);

const modelDir = 'hamux_model';
tf.loadGraphModel(modelDir + '/model.json', {
    onProgress: p => status.innerText = `loading model: ${Math.round(p*100)}%`
}).then(async model => {
  console.log('loaded', model)
  let keys = Object.keys(model.artifacts.signature.inputs)
  console.log("order", keys)
  console.log("order output", Object.keys(model.artifacts.signature.outputs))

  model.artifacts.signature.outputs // object_2, object_1, object_0
  status.textContent = 'ready!'
  const imgs = tf.ones([1,784]).cast('float32')
  const logits = tf.ones([1,10]).cast('float32')
  const dt = tf.tensor([0.2]).cast('float32')
  console.log("p5")

  // let outputs = awaijt model.executeAsync(
  //   { 'img_pixels' : imgs, "labels": logits, "dt": dt },
  //   [ 'energy','next_imgs','next_labels']);
  // tf.print(outputs);
  // BREAKS HERE
  const output = model.predict([imgs, logits, dt], ["Identity", "Identity_1", "Identity_2"])

  // Try model.execute(..., output_names=...)
  // 
  let [energy, x1next, x2next] = output
  console.log("p6")
  console.log("OUTPUT")

  energy = energy.dataSync()
  x1next = x1next.dataSync()
  x2next = x2next.dataSync()

  console.log(`Energy: ${energy.length}`)
  console.log(`Next imgs: ${x1next.length}`)
  console.log(`Next logits: ${x2next.length}`)

  console.log(`Energy: ${energy}`)
  console.log(`Next imgs: ${x1next}`)
  console.log(`Next logits: ${x2next}`)

  // console.log(`Energy: ${energy.dataSync()}`)
  // console.log(`Next imgs: ${newimgs.dataSync()}`)
  // console.log(`Next logits: ${newlogits.dataSync()}`)

  // const ui = mnist_ui(document.querySelector('#mnist'))
  // ui.onUpdate(img => {
  //   const imgs = tf.tensor(img).cast('float32').reshape([1, 28, 28, 1])
  //   const logits = model.predict(imgs)
  //   const preds = tf.softmax(logits)
  //   const { values, indices } = tf.topk(preds, 10)

  //   ui.showPreds([...values.dataSync()], [...indices.dataSync()])
  // })

}).catch(error => {
  status.textContent = 'ERROR : ' + error.message
})
</script>