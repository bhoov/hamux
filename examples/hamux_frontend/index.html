<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.1.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ramda/0.28.0/ramda.js"
  integrity="sha512-ZZcBsXW4OcbCTfDlXbzGCamH1cANkg6EfZAN2ukOl7s5q8skbB+WndmAqFT8fuMzeuHkceqd5UbIDn7fcqJFgg=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="mnist_ui.js"></script>
<script src="tfjsHelpers.js" type="module"></script>

<style>
  #mnist * {
    display: block;
  }

  #mnist canvas {
    border: 1px solid black;
  }
</style>

<pre id="status">initializing...</pre>
<div id="mnist"></div>

<script type="module">
  import { TFJSInterface } from "./tfjsHelpers.js"
  const status = document.querySelector('#status')

  window.onerror = (message, source, lineno, colno, error) =>
    status.innerText = `### JAVASCRIPT ERROR: ${message} at ${source}:${lineno}`;

  console.log(R.sortBy(R.identity)(["blank", 'aaa', "abc"]))

  const modelDir = 'hamux_model2';
  tf.loadGraphModel(modelDir + '/model.json', {
    onProgress: p => status.innerText = `loading model: ${Math.round(p * 100)}%`
  }).then(async model => {

    console.log(model)
    // TFJS has some weird ordering tricks. Standardize inside of the helper
    // const modelHelper = TFJSInterface(model, ["energy", "x1next", "x2next"])
    const modelHelper = TFJSInterface(model, ["energy", "x1next", "x2next", "g1next", "g2next"])

    status.textContent = 'ready!'

    let imgsSquare = tf.zeros([1, 28, 28]).cast('float32').bufferSync()
    let imgs = tf.zeros([1, 784]).cast('float32').bufferSync()
    let logits = tf.zeros([1, 10]).cast('float32').bufferSync()
    let dt = tf.tensor([0.02]).cast('float32').bufferSync()
    let computeDelay = 150

    console.log(imgsSquare.values)
    logits.values = [0, 1000, 0, 0, 0, 0, 0, 0, 0, 0]
    // console.log("L0: ", logits.get(0))
    // logits.set(1000, 0, 1)
    console.log(logits)

    /**
     * The basic stepping function of our model that descends the energy by a tiny amount. 
     * 
     * Interacts with and modifies global state variables `imgs`, `logits`, `dt`
     */
    async function step() {
      const output = modelHelper.predict([imgs.toTensor(), logits.toTensor(), dt.toTensor()])
      // tf.max(output.x1next).data().then(x => console.log(x))
      imgs.values = await output.x1next.data()
      logits.values = await output.x2next.data()
      const energyData = await output.energy.data()
      tf.max(output.g1next).data().then(x => console.log(x))
      // console.log(energyData)
      return true
    }

    /**
     * Repeatedly resubmit an (asynchronous function) `f` with some delay and some maxCount if desired
     */
    function repeatedResubmit(f, delay=100, maxCount=null) {
      let n = 0
      const repeater = async () => {
        const out = await f()
        n+=1
        if ((maxCount != null) && (n < maxCount)) {
          setTimeout(repeater, delay)
        }
      }
      return repeater
    }

    repeatedResubmit(step, 10, 5000)()


  }).catch(error => {
    status.textContent = 'ERROR : ' + error.message
  })
</script>