<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.1.0"></script>
<script src="mnist_ui.js"></script>
<style>
  #mnist * { display: block; }
  #mnist canvas { border: 1px solid black; }
</style>

<pre id="status">initializing...</pre>
<div id="mnist"></div>

<script>

const status = document.querySelector('#status')
status.innerText = 'loading model: 0%'

window.onerror = (message, source, lineno, colno, error) =>
  status.innerText = `### JAVASCRIPT ERROR: ${message} at ${source}:${lineno}`;

// Bypass finite-ness checking
const IsFinite = (node) => {
  if (node.inputs) {
    return tf.logicalNot(tf.logicalOr(tf.isNaN(node.inputs[0]), tf.isInf(node.inputs[0])))
  }
  return true
  // return true
}
tf.registerOp('IsFinite', IsFinite);

const modelDir = 'flax_model';
tf.loadGraphModel(modelDir + '/model.json', {
    onProgress: p => status.innerText = `loading model: ${Math.round(p*100)}%`
}).then(async model => {
  console.log('loaded', model)
  status.textContent = 'ready!'

  // const imgs = tf.ones([1,28,28]).cast('float32')
  const imgs = tf.ones([784,]).cast('float32')
  const logits = tf.zeros([10,]).cast('float32')
  const dt = tf.tensor([0.000001]).cast('float32')
  console.log("p5")

  const input = {
    "xs_0": imgs,
    "xs_1": logits
  }
  // const output = model.predict(input)
  const output = model.execute(input)
  // const output = model.predict(input)

  // const output = model.predict(imgs)

  // const imglogits = tf.ones([1,794]).cast('float32')
  // const output = model.execute([imglogits])

  // const imgflat= tf.ones([1,784]).cast('float32')
  // const imgflat= tf.ones([794,]).cast('float32')
  // const output = model.execute([imgflat])
  console.log(output)
  let [x2next, energy, x1next] = output
  console.log(output.length)
  console.log(Object.keys(output))
  // const outputData = await output[0].data()
  // console.log("OUTPUT", outputData)

  energy = energy.dataSync()
  x1next = x1next.dataSync()
  x2next = x2next.dataSync()

  console.log(`Energy: ${energy.length}`)
  console.log(`Next imgs: ${x1next.length}`)
  console.log(`Next logits: ${x2next.length}`)

  console.log(`Energy: ${energy}`)
  console.log(`Next imgs: ${x1next}`)
  console.log(`Next logits: ${x2next}`)


  // const ui = mnist_ui(document.querySelector('#mnist'))
  // ui.onUpdate(img => {
  //   const imgs = tf.tensor(img).cast('float32').reshape([1, 28, 28, 1])
  //   const logits = model.predict(imgs)
  //   const preds = tf.softmax(logits)
  //   const { values, indices } = tf.topk(preds, 10)

  //   ui.showPreds([...values.dataSync()], [...indices.dataSync()])
  // })

})
// .catch(error => {
//   status.textContent = 'ERROR : ' + error.message
// })
</script>